name: Build Linux Server

on:
  push:
    branches: [ "master" ]
    paths:
      - 'server/**'
      - 'web-client/**'
      - '.github/workflows/build_linux.yml'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    # --- 1. Build Web Client ---
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: web-client/package-lock.json

    - name: Build Web Client
      working-directory: ./web-client
      run: |
        npm ci
        npm run build

    # --- 2. Install Linux Dependencies ---
    - name: Install System Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-dev libappindicator3-dev libgirepository1.0-dev pkg-config

    # --- 3. Build Python Server ---
    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        python-version: '3.13'
        enable-cache: true
        cache-dependency-glob: "server/uv.lock"

    - name: Build with PyInstaller
      working-directory: ./server
      # --add-data format for Linux: "source_path:dest_folder_name" (same as macOS)
      run: |
        uv run --frozen pyinstaller --clean --onefile --noconsole --name "RemoteMouse" --exclude-module tkinter --exclude-module unittest --add-data "../web-client/dist:web_dist" --add-data "src/server/assets:assets" src/server/main.py

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: RemoteMouse-linux
        path: server/dist/RemoteMouse
