# Remote Mouse 需求文档 V3 (迭代版)

**版本**: 3.1
**状态**: 已完成 (Project Aether)

## 1. 核心变更目标
基于 V2 版本的功能基础，通过极致优化通信链路与前端性能，实现媲美原生应用的流畅度：
*   **零安装 (Zero Installation)**: 移除 Mobile Native App，改为 **Web App** 方案。
*   **低延迟 (Low Latency)**: 采用 **WebSocket (Binary)** 协议，配合前端 **RAF (RequestAnimationFrame)** 驱动的发送机制，确保 60FPS 级别的平滑控制。
*   **自动发现 (Auto Discovery)**: 利用 **mDNS** 解决局域网服务发现，用户通过域名直接访问。
*   **高效传输**: 数据载荷采用 **二进制流 (Binary Stream)**，最小化带宽占用与解析开销；前端采用内存复用策略杜绝 GC 卡顿。

## 2. 架构设计 (Architecture)

### 2.1 服务端 (Server)
*   **语言**: Python 3.13+
*   **核心库**:
    *   **FastAPI**: 提供静态资源服务 (Web Client) 和高性能 WebSocket 接口。
    *   **zeroconf**: 实现 mDNS 服务注册与广播 (如 `remote-mouse.local`)。
    *   **pyautogui**: 执行鼠标与键盘模拟控制。
    *   **pystray**: 系统托盘管理 (最小化/退出)。

### 2.2 客户端 (Web Client)
*   **语言**: TypeScript (Vanilla)
*   **技术**: HTML5, CSS3, WebSocket API, Pointer Events API。
*   **运行环境**: 移动端现代浏览器 (Chrome for Android, Safari for iOS)。
*   **性能优化**:
    *   **RAF 驱动**: 使用 `requestAnimationFrame` 替代 `setTimeout` 进行数据发送，与屏幕刷新率同步。
    *   **零 GC (Zero GC)**: 复用 `ArrayBuffer` 和 `DataView` 对象，避免高频操作下的内存抖动。

## 3. 业务流程 (Workflow)

1.  **启动**: 服务端启动后，开启 HTTP/WebSocket 服务 (FastAPI) 并通过 mDNS 广播主机名。
2.  **访问**: 用户手机连接同一 Wi-Fi，浏览器访问 `http://hostname.local:<port>`。
3.  **连接**: 网页加载后，建立 WebSocket 长连接 (Binary Type: `arraybuffer`)。
4.  **交互**:
    *   用户触摸屏幕，输入事件被累加。
    *   浏览器每一帧 (RAF) 检查累加值，若有变化则写入预分配的 Buffer 并通过 WebSocket 发送。
5.  **执行**: 服务端解析二进制数据，立即驱动鼠标/键盘动作。

## 4. 通信协议 (Binary Protocol)

所有数据通过 WebSocket 以 `ArrayBuffer` 形式传输。采用 **大端序 (Big-Endian)**。

### 4.1 数据包结构

| 操作类型 (OpCode) | 结构描述 | 长度 (Bytes) | 备注 |
| :--- | :--- | :--- | :--- |
| **Move (0x01)** | `[OpCode: 1B] [DeltaX: Int16] [DeltaY: Int16]` | 5 | 鼠标移动 |
| **Click (0x02)** | `[OpCode: 1B] [Button: 1B]` | 2 | 0x01:左键, 0x02:右键 |
| **Scroll (0x03)** | `[OpCode: 1B] [ScrollX: Int16] [ScrollY: Int16]` | 5 | 滚轮滚动 |
| **Drag (0x04)** | `[OpCode: 1B] [State: 1B]` | 2 | 0x01:开始, 0x00:结束 |
| **Key (0x05)** | `[OpCode: 1B] [Char: UTF-8 Bytes...]` | Variable | 键盘输入 (备用) |

*   **Int16**: 范围 -32768 ~ 32767，足够覆盖单帧移动像素差。

## 5. 功能需求 (Functional Requirements)

### 5.1 手势交互 (Web Client)
需屏蔽浏览器默认行为 (Pull-to-refresh, Zooming)，实现全屏触控板：

*   **单指**:
    *   **移动**: 累加位移，RAF 周期发送 `Move` 指令。
    *   **轻触 (Tap)**: 发送 `Click (Left)` 指令。
*   **双指**:
    *   **移动**: 发送 `Scroll` 指令。
    *   **轻触 (Tap)**: 发送 `Click (Right)` 指令。
*   **三指**:
    *   **按下并移动**: 发送 `Drag (Start)`，随后发送 `Move` 指令。
    *   **抬起**: 发送 `Drag (End)`。

### 5.2 服务端逻辑
*   **连接管理**: 处理 WebSocket 连接/断开，记录日志。
*   **异常处理**: 客户端断开连接后，自动重置状态 (如释放可能按下的鼠标键)。