# Remote Mouse 需求文档 V3.2 (键盘输入迭代)

**版本**: 3.2（keyboard input）
**状态**: 已实现
**基础版本**: V3.1

## 1. 核心变更
在 V3.1 基础上，新增 **移动端原生键盘输入** 支持。用户可通过界面按钮唤起手机键盘，将输入的字符实时传输至电脑端。

## 2. 界面布局 (UI Layout)
调整 Web Client 的布局结构，由“全屏触控板”改为“触控板 + 底部工具栏”：

*   **触控板区域 (Touchpad Area)**:
    *   占据屏幕剩余主要空间（Flex-grow: 1）。
    *   保持原有的手势交互（移动、点击、滚动、拖拽）。
*   **底部工具栏 (Bottom Toolbar)**:
    *   **位置**: 固定在屏幕底部。
    *   **高度**: 固定高度（如 50px - 60px），防止误触。
    *   **内容**:
        *   **键盘按钮 (Keyboard Toggle)**: 图标按钮。
            *   状态 1 (默认): 点击唤起手机原生键盘。
            *   状态 2 (键盘已开): 点击收起键盘。

## 3. 交互逻辑 (Interaction)

### 3.1 键盘唤起与隐藏
1.  用户点击底部工具栏的“键盘图标”。
2.  Web Client 聚焦一个不可见（或透明）的输入组件（`<textarea>` 或 `contenteditable`），触发手机原生键盘弹出。
3.  用户在手机键盘输入字符。
4.  用户再次点击“键盘图标”或点击触控板区域，输入组件失焦，键盘收起。

### 3.2 输入处理
通过监听输入组件的 `input` 事件（或 `beforeinput` 事件）捕获用户行为：

*   **普通文本**: 捕获输入的字符（包括中文、表情符号等），发送 `Text` 指令。
*   **回车 (Enter)**: 捕获换行操作，发送 `KeyAction` 指令 (`enter`)。
*   **退格 (Backspace)**: 捕获删除操作，发送 `KeyAction` 指令 (`backspace`)。

> **注意**: V3.2 暂不支持 Ctrl, Alt, Win, Shift, Tab, Esc, 方向键等 PC 专用控制键，仅聚焦于原生输入法支持的文本与基本编辑键。

## 4. 通信协议更新 (Protocol Update)

在原有协议基础上，重构/新增键盘相关指令。

### 4.1 数据包结构更新

| 操作类型 (OpCode) | 结构描述 | 长度 (Bytes) | 说明 |
| :--- | :--- | :--- | :--- |
| Move, Click, Scroll, Drag | 保持不变 | ... | 见 V3.1 |
| **Text (0x05)** | `[OpCode: 1B] [UTF-8 Bytes...]` | Variable | **变更**: 发送纯文本字符串。服务端使用 `write()` 输出。 |
| **KeyAction (0x06)** | `[OpCode: 1B] [KeyName: UTF-8 Bytes...]` | Variable | **新增**: 发送功能键名。服务端使用 `press()` 按下。 |

### 4.2 服务端处理逻辑
*   **收到 Text (0x05)**:
    *   解析 UTF-8 字符串。
    *   调用 `pyautogui.write(text)`。
*   **收到 KeyAction (0x06)**:
    *   解析键名字符串 (如 "enter", "backspace")。
    *   调用 `pyautogui.press(key_name)`。

## 5. 实现细节备忘

*   **Web 前端**:
    *   **Hidden Input**: 为了兼容性，建议使用 `opacity: 0; position: absolute; ...` 的 `<textarea>` 元素，而非 `type="hidden"`。
    *   **中文输入**: 监听 `compositionstart` 和 `compositionend` 事件。通常只在 `compositionend` (上屏) 或非 IME 输入状态下的 `input` 事件中发送数据，避免发送拼音过程中的字母。
    *   **删除键**: Android Chrome 有时在 `input` 事件中无法准确捕获 Backspace（特别是输入框为空时）。建议在 `beforeinput` 事件中检查 `inputType === 'deleteContentBackward'`。

*   **Python 服务端**:
    *   确保 `pyautogui.write` 对非 ASCII 字符（如中文）的支持。
    *   *风险提示*: Windows/Linux 下 `pyautogui.write` 可能不支持直接输入中文，可能需要通过剪贴板粘贴 (`pyperclip.copy(text)` -> `hotkey('ctrl', 'v')`) 的方式变通实现。
    *   **V3.2 决策**: 优先尝试直接 write，若中文乱码，则在服务端实现中加入“剪贴板回退机制”。

## 6. 后续规划 (V3.3+)
*   增加控制键（Ctrl, Alt, Win, Tab 等）的专用按钮栏。
*   支持媒体控制键（音量、播放/暂停）。
