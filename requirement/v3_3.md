# Remote Mouse 需求文档 V3.3 (特殊功能键迭代)

**版本**: 3.3 (Special Function Keys)
**状态**: 已完成
**基础版本**: V3.2

## 1. 核心变更
在 V3.2 基础上，新增 **特殊功能键 (Function Keys)** 控制区域。支持常用系统操作键、修饰键以及方向键，并通过“粘滞逻辑”实现组合键操作。

## 2. 界面布局 (UI Layout)
在触控板与底部工具栏之间，新增一个“功能键面板”：

*   **布局**: 6 列 x 2 行的网格矩阵。
*   **样式**: 按钮采用紧凑设计，文字/图标居中。
*   **视觉反馈**:
    *   普通键（如 Enter, Esc）：点击时产生即时点击效果（波纹或变色）。
    *   修饰键（Ctrl, Alt, Shift, Win/Cmd）：点击后保持高亮状态（背景色持续改变），直到下次操作后熄灭。

### 2.1 按键排列图
| 列 1 | 列 2 | 列 3 | 列 4 | 列 5 | 列 6 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| **Esc** | **Tab** | **Win/Cmd** | **Alt** | **Shift** | **Ctrl** |
| **Back** | **Enter** | **←** | **↓** | **↑** | **→** |

## 3. 交互逻辑 (Interaction)

### 3.1 粘滞键 (Sticky Keys) 处理
修饰键（Ctrl, Alt, Shift, Win/Cmd）采用“点击生效，操作后重置”的逻辑：

1.  **激活**: 用户点击任意修饰键（例如 `Ctrl`），Web 端 UI 将该键设为“选中状态”，并暂存该状态。
2.  **组合触发**:
    *   若用户接着点击**普通功能键**（例如 `Enter`）：发送 `Ctrl + Enter`。
    *   若用户接着点击**触控板进行点击**：发送 `Ctrl + Left Click`（用于多选）。
    *   若用户接着通过**原生键盘输入字符**（例如 `C`）：发送 `Ctrl + C`。
3.  **自动释放**: 任何非修饰键的操作完成后，所有已激活的修饰键状态**自动清空**，UI 恢复初始状态。

### 3.2 连续操作
用户可以同时点亮多个修饰键（例如同时点亮 `Ctrl` 和 `Alt`），下一次操作将带上所有已点亮的修饰键（例如 `Ctrl + Alt + Delete`）。

## 4. 通信协议更新 (Protocol Update)

为了支持组合操作，需要扩展 `Click` (0x02) 和 `KeyAction` (0x06) 的定义，增加修饰键位掩码 (Modifier Mask)。

### 4.1 修饰键位掩码定义 (1 Byte)
使用一个字节的位运算来记录修饰键状态：
*   Bit 0: Ctrl
*   Bit 1: Shift
*   Bit 2: Alt
*   Bit 3: Win/Cmd
*   (Bit 4-7: 预留)

### 4.2 数据包结构变更

| 操作类型 (OpCode) | 结构描述 | 长度 (Bytes) | 说明 |
| :--- | :--- | :--- | :--- |
| **Click (0x02)** | `[OpCode] [Button] [ModifierMask]` | 3B | **变更**: 增加 1 字节掩码。 |
| **KeyAction (0x06)** | `[OpCode] [ModifierMask] [KeyName: UTF8]` | Variable | **变更**: 增加 1 字节掩码。 |
| **Text (0x05)** | 保持不变 | Variable | 纯文本输入通常不配合修饰键。 |

## 5. 服务端处理逻辑

*   **收到 Click/KeyAction**:
    1.  解析 `ModifierMask`，识别出哪些修饰键需要按下。
    2.  使用 `pyautogui.keyDown()` 依次按下所有激活的修饰键。
    3.  执行核心动作：`pyautogui.click()` 或 `pyautogui.press()`。
    4.  使用 `pyautogui.keyUp()` 依次释放所有修饰键。

## 6. 开发建议

*   **CSS Grid**: 使用 `display: grid` 轻松实现 6x2 布局。
*   **状态管理**: 在 Web 前端维护一个 `activeModifiers` 对象或数组，每次点击修饰键时切换其布尔值，每次发送指令后重置该对象。
